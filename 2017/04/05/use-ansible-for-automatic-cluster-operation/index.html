<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>使用Ansible进行服务器自动化运维 | JetMuffin&#39;s Blog</title>
  <meta name="description" content="A minimal hexo theme." />
  <meta name="keywords" content="hexo,theme,typescript,otakism,otaku" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Ansible进行服务器自动化运维">
<meta property="og:url" content="http://blog.jetmuffin.com/2017/04/05/use-ansible-for-automatic-cluster-operation/index.html">
<meta property="og:site_name" content="JetMuffin's Blog">
<meta property="og:description" content="ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。">
<meta property="og:updated_time" content="2017-04-05T11:09:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Ansible进行服务器自动化运维">
<meta name="twitter:description" content="ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。">
  
  
    <link rel="icon" href="/favicon.png">
  
  
	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  otaku keeps alive
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<div class="site-sidebar">
	
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          Home
        </a>
      
        <a href="/about" class="nav-about nav">
          About
        </a>
      
        <a href="/archives" class="nav-archives nav">
          Archives
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      <article id="post-use-ansible-for-automatic-cluster-operation"
  class="post article white-box article-type-post"
  itemscope itemprop="blogPost">
	<h2 class="title">
  	<a href="/2017/04/05/use-ansible-for-automatic-cluster-operation/">
    	使用Ansible进行服务器自动化运维
    </a>
  </h2>
	<time>
	  4月 5, 2017
	</time>
	<section class="content">
  	<div class="article-entry" itemprop="articleBody">
    	<blockquote>
<p>ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。</p>
</blockquote>
<a id="more"></a>
<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><p>Virtualbox &amp;&amp; Vagrant，安装 CentOS 7。用 Vagrant 自动分配 CPU、内存以及 IP。共两台虚拟机，一台为 master，一台为 slave，以模拟集群下环境。</p>
<ul>
<li>IP: 192.168.32.10(master) 192.168.32.11(slave)</li>
<li>子网掩码：255.255.255.0</li>
<li>用户：root</li>
</ul>
<h2 id="Ansible-脚本使用流程"><a href="#Ansible-脚本使用流程" class="headerlink" title="Ansible 脚本使用流程"></a>Ansible 脚本使用流程</h2><h3 id="安装-Ansible"><a href="#安装-Ansible" class="headerlink" title="安装 Ansible"></a>安装 Ansible</h3><p>Ansible 可以直接通过 yum 的 epel 源进行安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y install epel-release</div><div class="line">yum -y install ansible</div></pre></td></tr></table></figure>
<h3 id="配置-ssh-无密码登陆"><a href="#配置-ssh-无密码登陆" class="headerlink" title="配置 ssh 无密码登陆"></a>配置 ssh 无密码登陆</h3><p>Ansible 在集群的机器之间所有的操作都是基于 ssh 进行的，因此需要配置每台机器上 master 的无密码登陆。这里我们只要配置 slave 这台机器即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa -P <span class="string">""</span></div><div class="line">ssh-copy-id slave</div></pre></td></tr></table></figure>
<p>配置完 ssh-key 后尝试从 master 登录 slave，若不需密码则配置成功。</p>
<h3 id="Ansible-脚本使用"><a href="#Ansible-脚本使用" class="headerlink" title="Ansible 脚本使用"></a>Ansible 脚本使用</h3><p>从 gitlab 上 clone Ansible 运维的 playbooks 至 master，playbooks 的目录层级如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ics-cluster/ansible</div><div class="line">tree</div><div class="line">├── bin</div><div class="line">│   └── setup.sh</div><div class="line">├── firewall.yml</div><div class="line">├── group_vars</div><div class="line">│   └── all</div><div class="line">├── hosts</div><div class="line">├── keys.yml</div><div class="line">├── roles</div><div class="line">│   ├── authorized_keys</div><div class="line">│   ├── autofs</div><div class="line">│   ├── common</div><div class="line">│   ├── firewalld</div><div class="line">│   ├── nfs</div><div class="line">│   ├── nis</div><div class="line">│   ├── ntp</div><div class="line">│   └── user</div><div class="line">├── setup.retry</div><div class="line">├── setup.yml</div><div class="line">└── user.yml</div></pre></td></tr></table></figure>
<p>其中根目录下的 <code>yml</code> 文件为指定功能的 playbook，运行方法为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i host xxx.yml</div></pre></td></tr></table></figure>
<p>若需要对过程进行 debug，在命令后加上 <code>-vvv</code> 参数即可。</p>
<h3 id="Playbook-编写"><a href="#Playbook-编写" class="headerlink" title="Playbook 编写"></a>Playbook 编写</h3><p>编写 playbook 需要按照在单机上配置软件的过程，大体包括三个部分：安装软件、配置软件和启动服务。因此 <code>package</code>，<code>template</code> 和 <code>service</code> 是经常使用的三个模块。</p>
<p>根据具体需要部署的软件的部署流程，依次在 playbook 中写好每个阶段的任务。其中可能还会涉及到选择分支等高级用法，具体详询 <a href="http://docs.ansible.com/ansible/playbooks.html" target="_blank" rel="external">Ansible Playbook Documents</a>。</p>
<h2 id="具体问题解决"><a href="#具体问题解决" class="headerlink" title="具体问题解决"></a>具体问题解决</h2><p>在配置集群环境以及编写 ansible playbooks 的过程中，会遇到非常多的坑，这里记录了一些可能会遇到的问题。</p>
<h4 id="1-ansible-在某个节点-setup-阶段卡住"><a href="#1-ansible-在某个节点-setup-阶段卡住" class="headerlink" title="1. ansible 在某个节点 setup 阶段卡住"></a>1. ansible 在某个节点 setup 阶段卡住</h4><p>Setup 阶段 ansible 主要收集机器节点的一些信息，而在这个阶段卡住原因可能出在文件系统（fs）和挂载点（mounts）上。因此登录到这个节点上使用 <code>df</code> 或者 <code>mount</code> 去人为检查文件系统是否出现问题。</p>
<h4 id="2-在-目录下-df-或-ls-卡住"><a href="#2-在-目录下-df-或-ls-卡住" class="headerlink" title="2. 在 / 目录下 df 或 ls 卡住"></a>2. 在 / 目录下 df 或 ls 卡住</h4><p>出现这种状况极有可能的原因是挂载点的问题。检查 <code>/etc/fstab</code> 中所有挂载点是否正常。如果在 <code>/etc/fstab</code> 中配置了自动挂载 nfs，那么如果 nfs-server 挂掉了，就会导致 nfs-client 上的 <code>df</code> 或 <code>ls</code> 卡住。</p>
<p>当然在这种状况下使用 <code>umount /exports</code> 也会卡住，需要使用 <code>umount -l /exports</code> 来解除挂载。</p>
<h4 id="3-ypbind-服务无法启动"><a href="#3-ypbind-服务无法启动" class="headerlink" title="3. ypbind 服务无法启动"></a>3. ypbind 服务无法启动</h4><p>配置 NIS 时，在 client 上启动 <code>ypbind</code> 服务时会出现启动超时的问题，主要的原因是 client 无法和 server 端通信。以下是两个排查的方向：</p>
<ol>
<li>检查 server 端的防火墙配置（iptables 或 firewalld），打开 <code>ypserv</code> 和 <code>yppasswdd</code> 的端口</li>
<li>server 端在初次启动 <code>ypserv</code> 后需要对 yp 进行初始化，运行 <code>ypinit -m</code></li>
</ol>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="docs.ansible.com">Ansible Documentation</a></li>
<li><a href="http://cn.linux.vbird.org/linux_server/0330nfs.php" target="_blank" rel="external">鸟哥的Linux 私房菜– NFS 服务器
</a></li>
<li><a href="https://www.server-world.info/en/note?os=CentOS_7&amp;p=nis" target="_blank" rel="external">Configure NIS Server</a></li>
<li><a href="https://www.server-world.info/en/note?os=CentOS_7&amp;p=nis&amp;f=2" target="_blank" rel="external">Configure NIS Client</a></li>
</ul>

  	</div>
	  
	  <div class="article-tags tags">
		  
        <a class="tag-link" href="/tags/ansible/">ansible</a><a class="tag-link" href="/tags/centos/">centos</a>
      
	  </div>
	</section>
</article>


<section id="comments">
	<div id="disqus_thread"></div>
</section>


      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  
	<div class="search">
	  <form name="searchform" id="searchform" class="u-search-form">
	    <input type="text" id="searchinput" class="u-search-input" placeholder="Looking for something?" />
	    <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit">
	      <span class="icon icon-search"></span>
	    </button>
	  </form>
	</div>
	

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/artchen" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/otakism" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
        <a href="https://plus.google.com/+ArtChenOtakism/posts" class="social google"
          target="_blank" rel="external">
          <span class="icon icon-google"></span>
        </a>
      
        <a href="http://weibo.com/otakism/" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">JetMuffin&#39;s Blog</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  
<script>
  var disqus_shortname = 'jetmuffin';
  
  var disqus_url = 'http://blog.jetmuffin.com/2017/04/05/use-ansible-for-automatic-cluster-operation/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>

<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "google";
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
